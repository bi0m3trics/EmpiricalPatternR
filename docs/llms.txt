# EmpericalPatternR

Simulate realistic forest stand patterns using simulated annealing
optimization to match empirical targets from field data.

![EmpericalPatternR Banner](reference/figures/banner.png)

## Overview

**EmpericalPatternR** generates synthetic forest stands that match
observed ecological patterns. Using simulated annealing, the package
optimizes tree locations, sizes, and species to simultaneously match
multiple targets including stand density, species composition, size
distributions, canopy cover, fuel loads, and spatial patterns.

Perfect for: - **Fire behavior modeling** - Generate stands with
realistic fuel structures - **Restoration planning** - Create target
stand conditions - **Research** - Explore how stand structure affects
ecological processes - **Teaching** - Demonstrate pattern-based ecology

### Key Features

- **Pre-built configurations** for common forest types (pinyon-juniper,
  ponderosa pine)
- **Pattern matching** to empirical field data (Huffman et al. 2009)
- **Flexible allometry** with species-specific equations (Reese, Miller)
- **Fast C++ engine** with OpenMP parallelization (50-300× speedup)
- **Canopy fuel load** optimization for fire behavior
- **Nurse tree effects** for facilitation patterns
- **Comprehensive analysis** with automated reports and visualizations
- **Fully tested** with 62 unit tests covering all major functions

## Installation

Install from GitHub:

``` r
# Install devtools if needed
install.packages("devtools")

# Install EmpericalPatternR
devtools::install_github("yourusername/EmpericalPatternR")
```

## Quick Start

Use a pre-built configuration:

``` r
library(EmpericalPatternR)

# Get pre-built pinyon-juniper configuration (Huffman et al. 2009)
config <- pj_huffman_2009(
  density_ha = 927,
  cfl = 1.10,
  canopy_cover = 0.40,
  max_iterations = 10000
)

# Run simulation
set.seed(123)
result <- simulate_stand(
  targets = config$targets,
  weights = config$weights,
  plot_size = config$simulation$plot_size,
  max_iterations = config$simulation$max_iterations,
  use_nurse_effect = TRUE,
  mortality_prop = 0.10
)

# Comprehensive analysis (console output + CSV files + PDF plots)
analyze_simulation_results(
  result = result,
  targets = config$targets,
  prefix = "my_woodland",
  save_plots = TRUE
)
```

**Output:** - `my_woodland_all_trees.csv` - All trees with attributes -
`my_woodland_live_trees.csv` - Live trees only -
`my_woodland_summary.csv` - Summary statistics -
`my_woodland_plots.pdf` - Spatial and size distributions

## Documentation

**Get Started:** - [Getting Started
Guide](https://bi0m3trics.github.io/EmpericalPatternR/articles/getting-started.md) -
Installation, quick start, basic usage - [Pinyon-Juniper
Example](https://bi0m3trics.github.io/EmpericalPatternR/articles/pinyon-juniper.md) -
Complete P-J woodland workflow  
- [Ponderosa Pine
Example](https://bi0m3trics.github.io/EmpericalPatternR/articles/ponderosa-pine.md) -
Custom configurations for different forest types

**Key Functions:** -
[`?pj_huffman_2009`](https://bi0m3trics.github.io/EmpericalPatternR/reference/pj_huffman_2009.md) -
Pre-built P-J configuration -
[`?create_config`](https://bi0m3trics.github.io/EmpericalPatternR/reference/create_config.md) -
Build custom configurations -
[`?simulate_stand`](https://bi0m3trics.github.io/EmpericalPatternR/reference/simulate_stand.md) -
Main simulation engine -
[`?analyze_simulation_results`](https://bi0m3trics.github.io/EmpericalPatternR/reference/analyze_simulation_results.md) -
Comprehensive analysis -
[`?generate_config_template`](https://bi0m3trics.github.io/EmpericalPatternR/reference/generate_config_template.md) -
Generate editable configuration templates

**Full Reference:** - [Function
Reference](https://bi0m3trics.github.io/EmpericalPatternR/reference/index.md) -
All functions organized by topic

## Create Custom Configurations

For forest types beyond pinyon-juniper:

``` r
# Create custom configuration
config <- create_config(
  density_ha = 450,
  species_props = c(PIPO = 0.70, PSME = 0.20, ABCO = 0.10),
  mean_dbh = 35.0,
  mean_height = 18.0,
  canopy_cover = 0.45,
  cfl = 0.85,
  clark_evans_r = 1.4,
  plot_size = 100,
  max_iterations = 5000
)

# Or generate an editable template
generate_config_template(
  file = "my_config.R",
  config_name = "my_custom_config",
  base_config = "pj"  # Start from P-J template
)
# Edit my_config.R, then: source("my_config.R"); config <- my_custom_config()
```

See the [ponderosa pine
vignette](https://bi0m3trics.github.io/EmpericalPatternR/articles/ponderosa-pine.md)
for detailed custom configuration examples.

## Simulation Workflow

    1. Define Configuration
       ├─ Use pre-built: pj_huffman_2009()
       ├─ Create custom: create_config()
       └─ Or template: generate_config_template()

    2. Run Simulation
       └─ simulate_stand() with simulated annealing

    3. Analyze Results
       ├─ analyze_simulation_results() for comprehensive output
       ├─ CSV exports for further analysis
       └─ PDF plots for visualization

    4. Apply to Research
       ├─ Fire behavior modeling (FlamMap, FARSITE)
       ├─ Restoration target development
       └─ Ecological pattern analysis

## Realtime Simulation Graphics

![Output form the Simulations](img/Output.png)

## Allometric Equations

Built-in equations from published literature:

``` r
# Pinyon-juniper (default)
params_pj <- get_default_allometric_params()

# Ponderosa pine (Reese et al., Miller et al.)
params_pp <- get_ponderosa_allometric_params()

# Custom equations
my_params <- list(
  crown_radius = list(
    MYSP = list(a = -0.204, b = 0.649, c = 0.421)  # ln(CD) = a + b*ln(DBH) + c*ln(H)
  ),
  height = list(
    MYSP = list(a = 27.0, b = 0.025)  # H = 1.3 + a*(1-exp(-b*DBH))
  ),
  foliage = list(
    MYSP = list(a = -2.287, b = 1.924)  # ln(W_f) = a + b*ln(DBH)
  )
)

# Use in calculations
height <- calc_height(dbh = 40, species = "MYSP", params = my_params)
radius <- calc_crown_radius(dbh = 40, height = height, species = "MYSP", params = my_params)
```

## Performance

The package uses optimized C++ with OpenMP parallelization:

| Function | R Version | C++ Version | Speedup |
|----|----|----|----|
| [`calc_canopy_cover()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_canopy_cover.md) | 2.5s | 0.05s | **50×** |
| [`calc_tree_attributes()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_tree_attributes.md) | 15s | 0.05s | **300×** |
| Full simulation (10k iterations) | ~45 min | ~5 min | **9×** |

Fast versions available: -
[`calc_canopy_cover_fast()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_canopy_cover_fast.md) -
Parallelized canopy cover -
[`calc_tree_attributes_fast()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_tree_attributes_fast.md) -
Batch tree calculations -
[`calc_clark_evans_fast()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_clark_evans_fast.md) -
Optimized spatial index -
[`calc_stand_metrics_parallel()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_stand_metrics_parallel.md) -
Full metrics with parallelization

## Package Structure

    EmpericalPatternR/
    ├── R/
    │   ├── allometric_equations.R    # Species-specific equations
    │   ├── config_system.R           # Configuration management
    │   ├── forest_simulation.R       # Main simulation engine
    │   └── performance_utils.R       # Fast C++ wrappers
    ├── src/                          # C++ optimized functions
    │   ├── OptimizedUtilitiesOpenMP.cpp
    │   └── NumericUtilities.cpp
    ├── inst/examples/                # Complete working examples
    │   ├── example_01_pinyon_juniper.R
    │   └── example_02_ponderosa_pine.R
    ├── vignettes/                    # Extended tutorials
    │   ├── getting-started.Rmd
    │   ├── pinyon-juniper.Rmd
    │   └── ponderosa-pine.Rmd
    ├── tests/testthat/               # Unit tests (62 tests)
    └── man/                          # Function documentation

## Citation

If you use this package in your research, please cite:

``` r
citation("EmpericalPatternR")
```

### Original Idea

- Pommerening, A., 2006. Evaluating structural indices by reversing
  forest structural analysis. *Forest Ecology and Management* 224,
  266–277. <https://doi.org/10.1016/j.foreco.2005.12.039>

- Pommerening, A. and Stoyan, D., 2008. Reconstructing spatial tree
  point patterns from nearest neighbour summary statistics measured in
  small subwindows. *Canadian Journal of Forest Research* 38, 1110–1122.
  <https://doi.org/10.1139/X07-222>

## Contributing

Contributions are welcome! Please: 1. Fork the repository 2. Create a
feature branch 3. Add tests for new functionality 4. Ensure
[`devtools::check()`](https://devtools.r-lib.org/reference/check.html)
passes 5. Submit a pull request

## License

GPL-3 License.

## Contact

For questions or issues: - Open an issue on
[GitHub](https://github.com/bi0m3trics/EmpericalPatternR/issues) - See
[documentation](https://bi0m3trics.github.io/EmpericalPatternR/) -
Contact the package maintainer

------------------------------------------------------------------------

**Built with:** R, Rcpp, data.table, spatstat, ggplot2

# Package index

## Quick Start

Main functions for running simulations and analyzing results.

- [`simulate_stand()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/simulate_stand.md)
  : Simulate Forest Stand with Simulated Annealing
- [`analyze_simulation_results()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/analyze_simulation_results.md)
  : Analyze and Report Simulation Results
- [`pj_huffman_2009()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/pj_huffman_2009.md)
  : Create Pinyon-Juniper Configuration (Huffman et al. 2009)

## Configuration System

Functions for creating, validating, and managing simulation
configurations.

- [`create_config()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/create_config.md)
  : Create Custom Simulation Configuration
- [`validate_config()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/validate_config.md)
  : Validate Configuration
- [`print_config()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/print_config.md)
  : Print Configuration Summary
- [`save_config()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/save_config.md)
  : Export Configuration to File
- [`generate_config_template()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/generate_config_template.md)
  : Generate Template Configuration File

## Allometric Equations

Functions for calculating tree attributes from DBH and species.

- [`calc_height()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_height.md)
  : Calculate tree height from DBH using allometric equations
- [`calc_crown_radius()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_crown_radius.md)
  : Calculate crown radius from DBH and height using allometric
  equations
- [`calc_crown_base_height()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_crown_base_height.md)
  : Calculate crown base height from DBH and total height
- [`calc_canopy_fuel_mass()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_canopy_fuel_mass.md)
  : Calculate canopy fuel mass from DBH
- [`get_default_allometric_params()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/get_default_allometric_params.md)
  : Get default allometric parameters for pinyon-juniper woodland
- [`get_ponderosa_allometric_params()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/get_ponderosa_allometric_params.md)
  : Get default allometric parameters for ponderosa pine forest
- [`allometric_equations`](https://bi0m3trics.github.io/EmpericalPatternR/reference/allometric_equations.md)
  : Allometric Equations for Forest Simulation

## Stand Metrics

Functions for calculating stand-level characteristics.

- [`calc_canopy_cover()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_canopy_cover.md)
  : Calculate total canopy cover accounting for overlap
- [`calc_canopy_cover_fast()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_canopy_cover_fast.md)
  : Fast Canopy Cover Calculation (Vectorized)
- [`calc_stand_metrics()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_stand_metrics.md)
  : Calculate all stand-level metrics
- [`calc_stand_metrics_parallel()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_stand_metrics_parallel.md)
  : Parallel Metric Calculation
- [`calc_clark_evans_fast()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_clark_evans_fast.md)
  : Fast Spatial Pattern Metrics
- [`calc_tree_attributes()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_tree_attributes.md)
  : Calculate all tree attributes from basic measurements
- [`calc_tree_attributes_fast()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_tree_attributes_fast.md)
  : Batch Tree Attribute Calculation

## Energy Calculation

Functions for evaluating how well a stand matches target patterns.

- [`calc_energy()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_energy.md)
  : Calculate energy (deviation from targets)
- [`calc_energy_cached()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_energy_cached.md)
  : Energy Calculation with Caching
- [`calc_mortality_probability()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_mortality_probability.md)
  : Calculate Size-Dependent Mortality Probability
- [`calc_nurse_tree_energy()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/calc_nurse_tree_energy.md)
  : Calculate Nurse Tree Association Energy
- [`should_full_update()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/should_full_update.md)
  : Batch Update Check

## Perturbation Functions

Functions for modifying stand structure during optimization.

- [`perturb_add()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/perturb_add.md)
  : Add a new tree
- [`perturb_remove()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/perturb_remove.md)
  : Remove a random tree
- [`perturb_move()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/perturb_move.md)
  : Move a random tree to a new location
- [`perturb_dbh()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/perturb_dbh.md)
  : Adjust DBH of a random tree
- [`perturb_species()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/perturb_species.md)
  : Change species of a random tree
- [`perturb_add_with_nurse()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/perturb_add_with_nurse.md)
  : Add Tree with Nurse Tree Effect

## Mortality and History

Functions for simulating disturbance and tracking optimization.

- [`simulate_mortality()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/simulate_mortality.md)
  : Simulate Post-Disturbance Mortality
- [`update_history_efficient()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/update_history_efficient.md)
  : Memory-Efficient History Storage
- [`adaptive_temperature()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/adaptive_temperature.md)
  : Adaptive Temperature Schedule

## Visualization

Functions for plotting simulation results and progress.

- [`plot_simulation_results()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/plot_simulation_results.md)
  : Plot Simulation Results
- [`plot_progress()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/plot_progress.md)
  : Plot progress during simulation - showing objective progress
- [`print_simulation_summary()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/print_simulation_summary.md)
  : Print Simulation Summary

## Performance Utilities

Optimized versions of calculation functions.

- [`precompute_ce_table()`](https://bi0m3trics.github.io/EmpericalPatternR/reference/precompute_ce_table.md)
  : Pre-compute Clark-Evans Lookup Table

## Package Documentation

- [`EmpericalPatternR-package`](https://bi0m3trics.github.io/EmpericalPatternR/reference/EmpericalPatternR-package.md)
  [`EmpericalPatternR`](https://bi0m3trics.github.io/EmpericalPatternR/reference/EmpericalPatternR-package.md)
  : EmpericalPatternR: Forest Stand Pattern Simulation

# Articles

### Tutorials

- [Getting Started with
  EmpericalPatternR](https://bi0m3trics.github.io/EmpericalPatternR/articles/getting-started.md):
- [Pinyon-Juniper Woodland
  Simulation](https://bi0m3trics.github.io/EmpericalPatternR/articles/pinyon-juniper.md):
- [Ponderosa Pine Forest with Custom
  Configurations](https://bi0m3trics.github.io/EmpericalPatternR/articles/ponderosa-pine.md):
